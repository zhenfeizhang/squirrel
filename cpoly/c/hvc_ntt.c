// NTT functions for small ring with q = 61441 and n = 512
#include "params.h"
#include <stdint.h>

/// NTT forward table where the i-th element is g^rev(i) where
/// - g = 61 is a primitive root
/// - rev(i) is the reverse bit decomposition of i, i.e.,
///   0   ->  0
///   1   ->  100 0000
///   2   ->  010 0000
///   3   ->  110 0000   ...
static const uint16_t NTT_TABLE[] = {
    1,     32495, 5167,  44853, 23695, 51854, 41593, 46858, 36770, 59464, 15018,
    45488, 31770, 34468, 46679, 40138, 59983, 54742, 23757, 38991, 43973, 30739,
    61114, 3428,  27333, 56180, 38193, 34776, 5854,  4394,  18646, 32069, 1162,
    34416, 44277, 17218, 8022,  42168, 38440, 12270, 25245, 37484, 1672,  17796,
    52140, 53725, 50036, 6637,  26152, 18769, 18625, 25525, 39155, 21497, 50113,
    51112, 57390, 30818, 19864, 42975, 43838, 6225,  39420, 30932, 54092, 15412,
    59696, 6268,  50680, 43477, 2018,  17363, 56229, 28897, 42195, 9169,  59511,
    15911, 42573, 4079,  24108, 16710, 25129, 15965, 22083, 17646, 6924,  59879,
    41853, 16700, 43572, 25736, 49095, 26460, 45417, 12595, 761,   29413, 61304,
    33378, 29682, 15772, 10158, 23158, 26315, 31528, 672,   25085, 30657, 56282,
    9821,  8841,  57841, 1664,  15423, 57589, 39549, 44799, 58358, 28186, 33355,
    51485, 3280,  44906, 31142, 26020, 58176, 12432, 21616, 18408, 51575, 3468,
    18944, 7901,  8135,  27643, 19544, 28104, 36285, 28285, 14263, 26722, 29162,
    14647, 3105,  10853, 7434,  43259, 28098, 31250, 58724, 1802,  13472, 5515,
    58612, 48822, 33045, 54359, 60417, 26142, 49864, 8628,  25175, 36151, 17050,
    26253, 52397, 48964, 38399, 31677, 14644, 57676, 45977, 23259, 32253, 657,
    44432, 15781, 36568, 8220,  24705, 869,   37778, 4930,  48450, 18566, 30516,
    21121, 59106, 3810,  38932, 25150, 30442, 12690, 4854,  11683, 5850,  58737,
    59419, 36980, 20202, 28346, 56916, 49879, 61000, 46899, 56111, 3829,  37407,
    53162, 50024, 46784, 10999, 10208, 60349, 28358, 37164, 21325, 23263, 22562,
    28568, 5091,  29574, 8449,  45029, 61381, 49217, 58626, 39190, 52884, 46635,
    23501, 4262,  5676,  25876, 20535, 40527, 59912, 12081, 25546, 28147, 26039,
    4702,  49164, 1110,  3583,  21357, 19620, 52986, 18927, 59007, 43178, 17876,
    17406, 19469, 48619, 3721,  59448, 56815, 24257, 1260,  23994, 59115, 50501,
    53504, 16503, 32109, 52334, 3686,  28061, 60293, 51868, 43031, 18067, 47639,
    23310, 6150,  38118, 12053, 37301, 21238, 23498, 3120,  6750,  32620, 6768,
    14877, 10327, 22932, 18892, 31396, 46656, 50977, 48255, 592,   6007,  54797,
    6894,  15971, 46959, 43703, 43152, 17726, 58436, 50489, 42473, 59618, 52180,
    19144, 55596, 58479, 27857, 40715, 24872, 421,   40493, 56784, 61409, 22153,
    18979, 57057, 23599, 19601, 37089, 17851, 3764,  13176, 33232, 21504, 3987,
    25840, 18094, 7067,  37148, 19235, 2032,  2008,  61059, 53248, 53759, 24226,
    41778, 20425, 24693, 43519, 23849, 50054, 38578, 18402, 29178, 33907, 47953,
    5395,  19352, 43192, 27277, 37245, 11457, 11703, 30636, 42602, 24819, 42872,
    12406, 40201, 34394, 47987, 26426, 59979, 47644, 3089,  43902, 10634, 7646,
    17624, 319,   3135,  2647,  39562, 37147, 1656,  50845, 16253, 55840, 6867,
    50894, 30332, 1818,  17797, 30823, 41363, 7369,  38521, 2402,  30608, 52,
    49040, 21024, 6996,  3320,  2797,  17276, 13464, 52760, 41517, 34878, 27808,
    8173,  54897, 21,    41143, 47066, 17004, 6067,  60479, 13279, 53565, 32586,
    40091, 23522, 35938, 57664, 16944, 22479, 32354, 26279, 53598, 60424, 28673,
    37811, 19140, 48498, 55182, 44946, 39154, 50443, 11569, 38617, 56371, 35112,
    14556, 24402, 7068,  8202,  36087, 45580, 49535, 8507,  38919, 32802, 59521,
    33656, 17736, 14740, 33381, 36181, 29299, 42710, 58750, 47939, 17946, 18739,
    12513, 54838, 27582, 37223, 34515, 20911, 7573,  13430, 53215, 25921, 44994,
    29994, 52695, 24796, 8598,  19783, 4023,  42378, 3302,  22504, 42277, 31796,
    26497, 47282, 19451, 16678, 7124,  46133, 6549,  39572, 24753, 24604, 40030,
    7439,  39523, 60103, 46898, 29387, 13763, 61087, 26184, 14112, 58178, 15981,
    36354, 58564, 37434, 8912,  5210,  28995, 61,    16083, 7982,  32629, 32252,
    29603, 18092, 32052, 31094, 2285,  55924, 9923,  33299, 13554, 21133, 52219,
    33944, 21448, 36034, 43693, 40390, 31849, 41494, 24785, 8406,  47725, 56456,
    32342, 49889, 22270, 31468, 51538, 9441,  10382, 58934, 5801,  59255, 53167,
    10082, 11178, 3920,  13207, 40551, 41059, 47049, 20852, 41587, 36211, 59247,
    38971, 30187, 21000, 53697, 21056, 46284, 45782, 60094, 36668, 44325, 40953,
    32155, 11079, 8421,  43622, 43239, 18517, 16437, 13702, 19430, 10134, 216,
    14646, 50714, 42369, 54814, 6340,  5152,  48956, 16431, 3055,  57445, 36254,
    58285, 52250, 56802, 31909, 53718, 27600, 33952, 35644, 15929, 33871, 45627,
    16594, 5592,  31003, 46421, 12404, 53084, 8505,  28813, 40477, 5228,  60936,
    7749,  18537, 40992, 55601, 26847, 53947, 46112, 47773, 26164, 40063, 19188,
    10792, 16290, 29335, 57701, 60439, 7102,  7094,  15757, 35862, 56432, 51195,
    46599, 21060, 28315, 16950, 12584, 27225, 49646, 51874, 4707,  27316, 24805,
    55437, 1509,  5037,  9869,  32576, 58534, 33293, 5082,  47623, 23387, 58277,
    55071, 1579,  18586, 48481, 23059, 29210, 11754, 28974, 49633, 59526, 60418,
    58637, 31095, 34780, 61091, 54776, 56994, 3967,  1285,  37636, 7581,  27626,
    33110, 16099, 39752, 5656,  1321,  40077, 6948,  41026, 18772, 9892,  32421,
    53009, 31141, 54966, 6282,  26588, 18246, 59561, 41888, 48087, 40094, 59566,
    13732, 36798, 50330, 36812, 49645, 19379, 60981, 43904, 3502,  8758,  31180,
    32010, 34540, 34553, 43516, 49246, 8510,  47950, 40855, 27538, 56529, 8278,
    56270, 9490,  55128, 10564, 5900,  24580, 22300, 3346,  22225, 23861, 43365,
    57781, 53069, 12608, 55832, 30992, 18449, 20418, 14218, 39031, 42411, 23815,
    14507, 29613, 61090, 22281, 58060, 52354, 41058, 49836, 6269,  34240, 12516,
    29441, 37214, 48609, 35849, 53336, 45939, 17269, 20230, 16591, 42658, 1309,
    25019, 5093,  15419, 50491, 42437, 8511,  7371,  23627, 53978, 58883, 40523,
    52814, 52854, 30457, 44369, 57590, 18252, 8767,  6504,  51881, 59382, 2044,
    5257,  20235, 5997,  43104, 23708, 44202, 47323, 15537, 47150, 46474, 10485,
    19730, 37547, 55828, 36112, 59222, 24803, 51888, 52616, 38213, 23920, 51750,
    36789, 1018,  7779,  10331, 11679, 49489, 405,   12101, 3641,  40370, 25975,
    42608, 25681, 12433, 23128, 59489, 61072, 51781, 39781, 26396, 28282, 50553,
    44414, 45281, 5003,  61040, 21483, 58884, 40215, 59237, 1000,  54152, 5956,
    1070,  61047, 38139, 53196, 22926, 3202,  29377, 17105, 31689, 12696, 41646,
    42685, 18500, 16584, 59510, 40774, 37406, 21890, 13093, 54190, 4990,  60069,
    23026, 38032, 25566, 18200, 39375, 34670, 19474, 56062, 9040,  39480, 14520,
    33700, 18557, 4106,  36059, 34264, 36319, 30567, 19459, 6912,  38585, 17083,
    54091, 39575, 29495, 8377,  26985, 50241, 32484, 7022,  49457, 41120, 36973,
    4062,  19422, 15023, 23640, 23858, 3172,  42272, 53644, 58110, 18197, 47735,
    9339,  22571, 23428, 13456, 38564, 37381, 7025,  30903, 1281,  52083, 44740,
    54188, 1441,  2759,  11286, 11092, 21634, 49352, 21699, 41783, 15367, 50528,
    19517, 7482,  5553,  13105, 60845, 28705, 33154, 161,   9210,  48288, 38302,
    53636, 4973,  29858, 20879, 59376, 52838, 27742, 13938, 1061,  8794,  50872,
    15535, 11026, 27399, 39301, 34810, 5762,  25463, 37399, 38966, 8688,  56606,
    5450,  24788, 20172, 36552, 50209, 37141, 26001, 27304, 23595, 58727, 16421,
    46751, 31866, 20497, 51183, 45156, 41230, 47845, 19463, 37972, 32950, 39384,
    61080, 4536,  17099, 21042, 59816, 34885, 18851, 57916, 19132, 34302, 4477,
    49268, 30843, 17693, 35349, 26260, 45631, 23692, 14704, 41264, 34492, 10818,
    40810, 39847, 61199, 658,   46721, 53226, 5718,  8826,  10157, 52104, 10605,
    48347,
};

/// NTT reverse table where the i-th element is (1/g)^rev(i) where
/// - g = 61 is a primitive root
/// - 1/g = 49738
/// - rev(i) is the reverse bit decomposition of i, i.e.,
///   0   ->  0
///   1   ->  100 0000
///   2   ->  010 0000
///   3   ->  110 0000   ...
static const uint16_t INV_NTT_TABLE[] = {
    1,     28946, 16588, 56274, 14583, 19848, 9587,  37746, 21303, 14762, 26973,
    29671, 15953, 46423, 1977,  24671, 29372, 42795, 57047, 55587, 26665, 23248,
    5261,  34108, 58013, 327,   30702, 17468, 22450, 37684, 6699,  1458,  30509,
    22021, 55216, 17603, 18466, 41577, 30623, 4051,  10329, 11328, 39944, 22286,
    35916, 42816, 42672, 35289, 54804, 11405, 7716,  9301,  43645, 59769, 23957,
    36196, 49171, 23001, 19273, 53419, 44223, 17164, 27025, 60279, 49009, 3265,
    35421, 30299, 16535, 58161, 9956,  28086, 33255, 3083,  16642, 21892, 3852,
    46018, 59777, 3600,  52600, 51620, 5159,  30784, 36356, 60769, 29913, 35126,
    38283, 51283, 45669, 31759, 28063, 137,   32028, 60680, 48846, 16024, 34981,
    12346, 35705, 17869, 44741, 19588, 1562,  54517, 43795, 39358, 45476, 36312,
    44731, 37333, 57362, 18868, 45530, 1930,  52272, 19246, 32544, 5212,  44078,
    59423, 17964, 10761, 55173, 1745,  46029, 7349,  12822, 41972, 44035, 43565,
    18263, 2434,  42514, 8455,  41821, 40084, 57858, 60331, 12277, 56739, 35402,
    33294, 35895, 49360, 1529,  20914, 40906, 35565, 55765, 57179, 37940, 14806,
    8557,  22251, 2815,  12224, 60,    16412, 52992, 31867, 56350, 32873, 38879,
    38178, 40116, 24277, 33083, 1092,  51233, 50442, 14657, 11417, 8279,  24034,
    57612, 5330,  14542, 441,   11562, 4525,  33095, 41239, 24461, 2022,  2704,
    55591, 49758, 56587, 48751, 30999, 36291, 22509, 57631, 2335,  40320, 30925,
    42875, 12991, 56511, 23663, 60572, 36736, 53221, 24873, 45660, 17009, 60784,
    29188, 38182, 15464, 3765,  46797, 29764, 23042, 12477, 9044,  35188, 44391,
    25290, 36266, 52813, 11577, 35299, 1024,  7082,  28396, 12619, 2829,  55926,
    47969, 59639, 2717,  30191, 33343, 18182, 54007, 50588, 58336, 46794, 32279,
    34719, 47178, 33156, 25156, 33337, 41897, 33798, 53306, 53540, 42497, 57973,
    9866,  43033, 39825, 32446, 56231, 52529, 24007, 2877,  25087, 45460, 3263,
    47329, 35257, 354,   47678, 32054, 14543, 1338,  21918, 54002, 21411, 36837,
    36688, 21869, 54892, 15308, 54317, 44763, 41990, 14159, 34944, 29645, 19164,
    38937, 58139, 19063, 57418, 41658, 52843, 36645, 8746,  31447, 16447, 35520,
    8226,  48011, 53868, 40530, 26926, 24218, 33859, 6603,  48928, 42702, 43495,
    13502, 2691,  18731, 32142, 25260, 28060, 46701, 43705, 27785, 1920,  28639,
    22522, 52934, 11906, 15861, 25354, 53239, 54373, 37039, 46885, 26329, 5070,
    22824, 49872, 10998, 22287, 16495, 6259,  12943, 42301, 23630, 32768, 1017,
    7843,  35162, 29087, 38962, 44497, 3777,  25503, 37919, 21350, 28855, 7876,
    48162, 962,   55374, 44437, 14375, 20298, 61420, 6544,  53268, 33633, 26563,
    19924, 8681,  47977, 44165, 58644, 58121, 54445, 40417, 12401, 61389, 30833,
    59039, 22920, 54072, 20078, 30618, 43644, 59623, 31109, 10547, 54574, 5601,
    45188, 10596, 59785, 24294, 21879, 58794, 58306, 61122, 43817, 53795, 50807,
    17539, 58352, 13797, 1462,  35015, 13454, 27047, 21240, 49035, 18569, 36622,
    18839, 30805, 49738, 49984, 24196, 34164, 18249, 42089, 56046, 13488, 27534,
    32263, 43039, 22863, 11387, 37592, 17922, 36748, 41016, 19663, 37215, 7682,
    8193,  382,   59433, 59409, 42206, 24293, 54374, 43347, 35601, 57454, 39937,
    28209, 48265, 57677, 43590, 24352, 41840, 37842, 4384,  42462, 39288, 32,
    4657,  20948, 61020, 36569, 20726, 33584, 2962,  5845,  42297, 9261,  1823,
    18968, 10952, 3005,  43715, 18289, 17738, 14482, 45470, 54547, 6644,  55434,
    60849, 13186, 10464, 14785, 30045, 42549, 38509, 51114, 46564, 54673, 28821,
    54691, 58321, 37943, 40203, 24140, 49388, 23323, 55291, 38131, 13802, 43374,
    18410, 9573,  1148,  33380, 57755, 9107,  29332, 44938, 7937,  10940, 2326,
    37447, 60181, 37184, 4626,  1993,  57720, 13094, 50836, 9337,  51284, 52615,
    55723, 8215,  14720, 60783, 242,   21594, 20631, 50623, 26949, 20177, 46737,
    37749, 15810, 35181, 26092, 43748, 30598, 12173, 56964, 27139, 42309, 3525,
    42590, 26556, 1625,  40399, 44342, 56905, 361,   22057, 28491, 23469, 41978,
    13596, 20211, 16285, 10258, 40944, 29575, 14690, 45020, 2714,  37846, 34137,
    35440, 24300, 11232, 24889, 41269, 36653, 55991, 4835,  52753, 22475, 24042,
    35978, 55679, 26631, 22140, 34042, 50415, 45906, 10569, 52647, 60380, 47503,
    33699, 8603,  2065,  40562, 31583, 56468, 7805,  23139, 13153, 52231, 61280,
    28287, 32736, 596,   48336, 55888, 53959, 41924, 10913, 46074, 19658, 39742,
    12089, 39807, 50349, 50155, 58682, 60000, 7253,  16701, 9358,  60160, 30538,
    54416, 24060, 22877, 47985, 38013, 38870, 52102, 13706, 43244, 3331,  7797,
    19169, 58269, 37583, 37801, 46418, 42019, 57379, 24468, 20321, 11984, 54419,
    28957, 11200, 34456, 53064, 31946, 21866, 7350,  44358, 22856, 54529, 41982,
    30874, 25122, 27177, 25382, 57335, 42884, 27741, 46921, 21961, 52401, 5379,
    41967, 26771, 22066, 43241, 35875, 23409, 38415, 1372,  56451, 7251,  48348,
    39551, 24035, 20667, 1931,  44857, 42941, 18756, 19795, 48745, 29752, 44336,
    32064, 58239, 38515, 8245,  23302, 394,   60371, 55485, 7289,  60441, 2204,
    21226, 2557,  39958, 401,   56438, 16160, 17027, 10888, 33159, 35045, 21660,
    9660,  369,   1952,  38313, 49008, 35760, 18833, 35466, 21071, 57800, 49340,
    61036, 11952, 49762, 51110, 53662, 60423, 24652, 9691,  37521, 23228, 8825,
    9553,  36638, 2219,  25329, 5613,  23894, 41711, 50956, 14967, 14291, 45904,
    14118, 17239, 37733, 18337, 55444, 41206, 56184, 59397, 2059,  9560,  54937,
    52674, 43189, 3851,  17072, 30984, 8587,  8627,  20918, 2558,  7463,  37814,
    54070, 52930, 19004, 10950, 46022, 56348, 36422, 60132, 18783, 44850, 41211,
    44172, 15502, 8105,  25592, 12832, 24227, 32000, 48925, 27201, 55172, 11605,
    20383, 9087,  3381,  39160, 351,   31828, 46934, 37626, 19030, 22410, 47223,
    41023, 42992, 30449, 5609,  48833, 8372,  3660,  18076, 37580, 39216, 58095,
    39141, 36861, 55541, 50877, 6313,  51951, 5171,  53163, 4912,  33903, 20586,
    13491, 52931, 12195, 17925, 26888, 26901, 29431, 30261, 52683, 57939, 17537,
    460,   42062, 11796, 24629, 11111, 24643, 47709, 1875,  21347, 13354, 19553,
    1880,  43195, 34853, 55159, 6475,  30300, 8432,  29020, 51549, 42669, 20415,
    54493, 21364, 60120, 55785, 21689, 45342, 28331, 33815, 53860, 23805, 60156,
    57474, 4447,  6665,  350,   26661, 30346, 2804,  1023,  1915,  11808, 32467,
    49687, 32231, 38382, 12960, 42855, 59862, 6370,  3164,  38054, 13818, 56359,
    28148, 2907,  28865, 51572, 56404, 59932, 6004,  36636, 34125, 56734, 9567,
    11795, 34216, 48857, 44491, 33126, 40381, 14842, 10246, 5009,  25579, 45684,
    54347, 54339, 1002,  3740,  32106, 45151, 50649, 42253, 21378, 35277, 13668,
    15329, 7494,  34594, 5840,  20449, 42904, 53692, 505,   56213, 20964, 32628,
    52936, 8357,  49037, 15020, 30438, 55849, 44847, 15814, 27570, 45512, 25797,
    27489, 33841, 7723,  29532, 4639,  9191,  3156,  25187, 3996,  58386, 45010,
    12485, 56289, 55101, 6627,  19072, 10727, 46795, 61225, 51307, 42011, 47739,
    45004, 42924, 18202, 17819, 53020, 50362, 29286, 20488, 17116, 24773, 1347,
    15659, 15157, 40385, 7744,  40441, 31254, 22470, 2194,  25230, 19854, 40589,
    14392, 20382, 20890, 48234, 57521, 50263, 51359, 8274,  2186,  55640, 2507,
    51059, 52000, 9903,  29973, 39171, 11552, 29099, 4985,  13716, 53035, 36656,
    19947, 29592, 21051, 17748, 25407, 39993, 27497, 9222,  40308, 47887, 28142,
    51518, 5517,  59156, 30347, 29389, 43349, 31838, 29189, 28812, 53459, 45358,
    61380,
};

/// convert a polynomial into its NTT form
void hvc_ntt(uint16_t *p) {
  unsigned int t, ht, i, j, j1, j2, l, m;
  uint32_t u, v, s;

  t = N;
  for (l = 0; l < 9; l++) {
    m = 1 << l;
    ht = t >> 1;
    i = 0;
    j1 = 0;
    while (i < m) {
      s = (uint32_t)(NTT_TABLE[m + i]);
      j2 = j1 + ht;
      j = j1;
      while (j < j2) {
        u = (uint32_t)(p[j]);
        v = ((uint32_t)(p[j + ht]) * s) % 61441;
        p[j] = (uint16_t)((u + v) % 61441);
        p[j + ht] = (uint16_t)((u + 61441 - v) % 61441);
        j++;
      }
      i++;
      j1 += t;
    }
    t = ht;
  }
}

/// convert an NTT form polynomial into its integer form
void hvc_inv_ntt(uint16_t *p) {
  unsigned int t, m, hm, dt, i, j, j1, j2;
  uint32_t s, u, v;

  t = 1;
  m = N;

  while (m > 1) {
    hm = m >> 1;
    dt = t << 1;
    i = 0;
    j1 = 0;
    while (i < hm) {
      j2 = j1 + t;
      s = (uint32_t)(INV_NTT_TABLE[hm + i]);
      j = j1;
      while (j < j2) {
        u = (uint32_t)(p[j]);
        v = (uint32_t)(p[j + t]);
        p[j] = (uint16_t)((u + v) % 61441);
        p[j + t] = (uint16_t)(((u + 61441 - v) * s) % 61441);
        j++;
      }
      i++;
      j1 += dt;
    }
    t = dt;
    m = hm;
  }

  for (i = 0; i < N; i++) {
    p[i] = (uint16_t)((uint32_t)(p[i]) * 61321 % 61441);
  }
}
