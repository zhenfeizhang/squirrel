// NTT functions for small ring with q = 61441 and n = 512
#include "params.h"
#include <stdint.h>

/// NTT forward table where the i-th element is g^rev(i) where
/// - g = 61 is a primitive root
/// - rev(i) is the reverse bit decomposition of i, i.e.,
///   0   ->  0
///   1   ->  100 0000
///   2   ->  010 0000
///   3   ->  110 0000   ...
static const uint16_t NTT_TABLE[] = {
    1,     32495, 5167,  44853, 23695, 51854, 41593, 46858, 36770, 59464, 15018,
    45488, 31770, 34468, 46679, 40138, 59983, 54742, 23757, 38991, 43973, 30739,
    61114, 3428,  27333, 56180, 38193, 34776, 5854,  4394,  18646, 32069, 1162,
    34416, 44277, 17218, 8022,  42168, 38440, 12270, 25245, 37484, 1672,  17796,
    52140, 53725, 50036, 6637,  26152, 18769, 18625, 25525, 39155, 21497, 50113,
    51112, 57390, 30818, 19864, 42975, 43838, 6225,  39420, 30932, 54092, 15412,
    59696, 6268,  50680, 43477, 2018,  17363, 56229, 28897, 42195, 9169,  59511,
    15911, 42573, 4079,  24108, 16710, 25129, 15965, 22083, 17646, 6924,  59879,
    41853, 16700, 43572, 25736, 49095, 26460, 45417, 12595, 761,   29413, 61304,
    33378, 29682, 15772, 10158, 23158, 26315, 31528, 672,   25085, 30657, 56282,
    9821,  8841,  57841, 1664,  15423, 57589, 39549, 44799, 58358, 28186, 33355,
    51485, 3280,  44906, 31142, 26020, 58176, 12432, 21616, 18408, 51575, 3468,
    18944, 7901,  8135,  27643, 19544, 28104, 36285, 28285, 14263, 26722, 29162,
    14647, 3105,  10853, 7434,  43259, 28098, 31250, 58724, 1802,  13472, 5515,
    58612, 48822, 33045, 54359, 60417, 26142, 49864, 8628,  25175, 36151, 17050,
    26253, 52397, 48964, 38399, 31677, 14644, 57676, 45977, 23259, 32253, 657,
    44432, 15781, 36568, 8220,  24705, 869,   37778, 4930,  48450, 18566, 30516,
    21121, 59106, 3810,  38932, 25150, 30442, 12690, 4854,  11683, 5850,  58737,
    59419, 36980, 20202, 28346, 56916, 49879, 61000, 46899, 56111, 3829,  37407,
    53162, 50024, 46784, 10999, 10208, 60349, 28358, 37164, 21325, 23263, 22562,
    28568, 5091,  29574, 8449,  45029, 61381, 49217, 58626, 39190, 52884, 46635,
    23501, 4262,  5676,  25876, 20535, 40527, 59912, 12081, 25546, 28147, 26039,
    4702,  49164, 1110,  3583,  21357, 19620, 52986, 18927, 59007, 43178, 17876,
    17406, 19469, 48619, 3721,  59448, 56815, 24257, 1260,  23994, 59115, 50501,
    53504, 16503, 32109, 52334, 3686,  28061, 60293, 51868, 43031, 18067, 47639,
    23310, 6150,  38118, 12053, 37301, 21238, 23498, 3120,  6750,  32620, 6768,
    14877, 10327, 22932, 18892, 31396, 46656, 50977, 48255, 592,   6007,  54797,
    6894,  15971, 46959, 43703, 43152, 17726, 58436, 50489, 42473, 59618, 52180,
    19144, 55596, 58479, 27857, 40715, 24872, 421,   40493, 56784, 61409, 22153,
    18979, 57057, 23599, 19601, 37089, 17851, 3764,  13176, 33232, 21504, 3987,
    25840, 18094, 7067,  37148, 19235, 2032,  2008,  61059, 53248, 53759, 24226,
    41778, 20425, 24693, 43519, 23849, 50054, 38578, 18402, 29178, 33907, 47953,
    5395,  19352, 43192, 27277, 37245, 11457, 11703, 30636, 42602, 24819, 42872,
    12406, 40201, 34394, 47987, 26426, 59979, 47644, 3089,  43902, 10634, 7646,
    17624, 319,   3135,  2647,  39562, 37147, 1656,  50845, 16253, 55840, 6867,
    50894, 30332, 1818,  17797, 30823, 41363, 7369,  38521, 2402,  30608, 52,
    49040, 21024, 6996,  3320,  2797,  17276, 13464, 52760, 41517, 34878, 27808,
    8173,  54897, 21,    41143, 47066, 17004, 6067,  60479, 13279, 53565, 32586,
    40091, 23522, 35938, 57664, 16944, 22479, 32354, 26279, 53598, 60424, 28673,
    37811, 19140, 48498, 55182, 44946, 39154, 50443, 11569, 38617, 56371, 35112,
    14556, 24402, 7068,  8202,  36087, 45580, 49535, 8507,  38919, 32802, 59521,
    33656, 17736, 14740, 33381, 36181, 29299, 42710, 58750, 47939, 17946, 18739,
    12513, 54838, 27582, 37223, 34515, 20911, 7573,  13430, 53215, 25921, 44994,
    29994, 52695, 24796, 8598,  19783, 4023,  42378, 3302,  22504, 42277, 31796,
    26497, 47282, 19451, 16678, 7124,  46133, 6549,  39572, 24753, 24604, 40030,
    7439,  39523, 60103, 46898, 29387, 13763, 61087, 26184, 14112, 58178, 15981,
    36354, 58564, 37434, 8912,  5210,  28995, 61380, 45358, 53459, 28812, 29189,
    31838, 43349, 29389, 30347, 59156, 5517,  51518, 28142, 47887, 40308, 9222,
    27497, 39993, 25407, 17748, 21051, 29592, 19947, 36656, 53035, 13716, 4985,
    29099, 11552, 39171, 29973, 9903,  52000, 51059, 2507,  55640, 2186,  8274,
    51359, 50263, 57521, 48234, 20890, 20382, 14392, 40589, 19854, 25230, 2194,
    22470, 31254, 40441, 7744,  40385, 15157, 15659, 1347,  24773, 17116, 20488,
    29286, 50362, 53020, 17819, 18202, 42924, 45004, 47739, 42011, 51307, 61225,
    46795, 10727, 19072, 6627,  55101, 56289, 12485, 45010, 58386, 3996,  25187,
    3156,  9191,  4639,  29532, 7723,  33841, 27489, 25797, 45512, 27570, 15814,
    44847, 55849, 30438, 15020, 49037, 8357,  52936, 32628, 20964, 56213, 505,
    53692, 42904, 20449, 5840,  34594, 7494,  15329, 13668, 35277, 21378, 42253,
    50649, 45151, 32106, 3740,  1002,  54339, 54347, 45684, 25579, 5009,  10246,
    14842, 40381, 33126, 44491, 48857, 34216, 11795, 9567,  56734, 34125, 36636,
    6004,  59932, 56404, 51572, 28865, 2907,  28148, 56359, 13818, 38054, 3164,
    6370,  59862, 42855, 12960, 38382, 32231, 49687, 32467, 11808, 1915,  1023,
    2804,  30346, 26661, 350,   6665,  4447,  57474, 60156, 23805, 53860, 33815,
    28331, 45342, 21689, 55785, 60120, 21364, 54493, 20415, 42669, 51549, 29020,
    8432,  30300, 6475,  55159, 34853, 43195, 1880,  19553, 13354, 21347, 1875,
    47709, 24643, 11111, 24629, 11796, 42062, 460,   17537, 57939, 52683, 30261,
    29431, 26901, 26888, 17925, 12195, 52931, 13491, 20586, 33903, 4912,  53163,
    5171,  51951, 6313,  50877, 55541, 36861, 39141, 58095, 39216, 37580, 18076,
    3660,  8372,  48833, 5609,  30449, 42992, 41023, 47223, 22410, 19030, 37626,
    46934, 31828, 351,   39160, 3381,  9087,  20383, 11605, 55172, 27201, 48925,
    32000, 24227, 12832, 25592, 8105,  15502, 44172, 41211, 44850, 18783, 60132,
    36422, 56348, 46022, 10950, 19004, 52930, 54070, 37814, 7463,  2558,  20918,
    8627,  8587,  30984, 17072, 3851,  43189, 52674, 54937, 9560,  2059,  59397,
    56184, 41206, 55444, 18337, 37733, 17239, 14118, 45904, 14291, 14967, 50956,
    41711, 23894, 5613,  25329, 2219,  36638, 9553,  8825,  23228, 37521, 9691,
    24652, 60423, 53662, 51110, 49762, 11952, 61036, 49340, 57800, 21071, 35466,
    18833, 35760, 49008, 38313, 1952,  369,   9660,  21660, 35045, 33159, 10888,
    17027, 16160, 56438, 401,   39958, 2557,  21226, 2204,  60441, 7289,  55485,
    60371, 394,   23302, 8245,  38515, 58239, 32064, 44336, 29752, 48745, 19795,
    18756, 42941, 44857, 1931,  20667, 24035, 39551, 48348, 7251,  56451, 1372,
    38415, 23409, 35875, 43241, 22066, 26771, 41967, 5379,  52401, 21961, 46921,
    27741, 42884, 57335, 25382, 27177, 25122, 30874, 41982, 54529, 22856, 44358,
    7350,  21866, 31946, 53064, 34456, 11200, 28957, 54419, 11984, 20321, 24468,
    57379, 42019, 46418, 37801, 37583, 58269, 19169, 7797,  3331,  43244, 13706,
    52102, 38870, 38013, 47985, 22877, 24060, 54416, 30538, 60160, 9358,  16701,
    7253,  60000, 58682, 50155, 50349, 39807, 12089, 39742, 19658, 46074, 10913,
    41924, 53959, 55888, 48336, 596,   32736, 28287, 61280, 52231, 13153, 23139,
    7805,  56468, 31583, 40562, 2065,  8603,  33699, 47503, 60380, 52647, 10569,
    45906, 50415, 34042, 22140, 26631, 55679, 35978, 24042, 22475, 52753, 4835,
    55991, 36653, 41269, 24889, 11232, 24300, 35440, 34137, 37846, 2714,  45020,
    14690, 29575, 40944, 10258, 16285, 20211, 13596, 41978, 23469, 28491, 22057,
    361,   56905, 44342, 40399, 1625,  26556, 42590, 3525,  42309, 27139, 56964,
    12173, 30598, 43748, 26092, 35181, 15810, 37749, 46737, 20177, 26949, 50623,
    20631, 21594, 242,   60783, 14720, 8215,  55723, 52615, 51284, 9337,  50836,
    13094,
};

/// NTT reverse table where the i-th element is (1/g)^rev(i) where
/// - g = 61 is a primitive root
/// - 1/g = 49738
/// - rev(i) is the reverse bit decomposition of i, i.e.,
///   0   ->  0
///   1   ->  100 0000
///   2   ->  010 0000
///   3   ->  110 0000   ...
static const uint16_t INV_NTT_TABLE[] = {
    1,     28946, 16588, 56274, 14583, 19848, 9587,  37746, 21303, 14762, 26973,
    29671, 15953, 46423, 1977,  24671, 29372, 42795, 57047, 55587, 26665, 23248,
    5261,  34108, 58013, 327,   30702, 17468, 22450, 37684, 6699,  1458,  30509,
    22021, 55216, 17603, 18466, 41577, 30623, 4051,  10329, 11328, 39944, 22286,
    35916, 42816, 42672, 35289, 54804, 11405, 7716,  9301,  43645, 59769, 23957,
    36196, 49171, 23001, 19273, 53419, 44223, 17164, 27025, 60279, 49009, 3265,
    35421, 30299, 16535, 58161, 9956,  28086, 33255, 3083,  16642, 21892, 3852,
    46018, 59777, 3600,  52600, 51620, 5159,  30784, 36356, 60769, 29913, 35126,
    38283, 51283, 45669, 31759, 28063, 137,   32028, 60680, 48846, 16024, 34981,
    12346, 35705, 17869, 44741, 19588, 1562,  54517, 43795, 39358, 45476, 36312,
    44731, 37333, 57362, 18868, 45530, 1930,  52272, 19246, 32544, 5212,  44078,
    59423, 17964, 10761, 55173, 1745,  46029, 7349,  12822, 41972, 44035, 43565,
    18263, 2434,  42514, 8455,  41821, 40084, 57858, 60331, 12277, 56739, 35402,
    33294, 35895, 49360, 1529,  20914, 40906, 35565, 55765, 57179, 37940, 14806,
    8557,  22251, 2815,  12224, 60,    16412, 52992, 31867, 56350, 32873, 38879,
    38178, 40116, 24277, 33083, 1092,  51233, 50442, 14657, 11417, 8279,  24034,
    57612, 5330,  14542, 441,   11562, 4525,  33095, 41239, 24461, 2022,  2704,
    55591, 49758, 56587, 48751, 30999, 36291, 22509, 57631, 2335,  40320, 30925,
    42875, 12991, 56511, 23663, 60572, 36736, 53221, 24873, 45660, 17009, 60784,
    29188, 38182, 15464, 3765,  46797, 29764, 23042, 12477, 9044,  35188, 44391,
    25290, 36266, 52813, 11577, 35299, 1024,  7082,  28396, 12619, 2829,  55926,
    47969, 59639, 2717,  30191, 33343, 18182, 54007, 50588, 58336, 46794, 32279,
    34719, 47178, 33156, 25156, 33337, 41897, 33798, 53306, 53540, 42497, 57973,
    9866,  43033, 39825, 32446, 56231, 52529, 24007, 2877,  25087, 45460, 3263,
    47329, 35257, 354,   47678, 32054, 14543, 1338,  21918, 54002, 21411, 36837,
    36688, 21869, 54892, 15308, 54317, 44763, 41990, 14159, 34944, 29645, 19164,
    38937, 58139, 19063, 57418, 41658, 52843, 36645, 8746,  31447, 16447, 35520,
    8226,  48011, 53868, 40530, 26926, 24218, 33859, 6603,  48928, 42702, 43495,
    13502, 2691,  18731, 32142, 25260, 28060, 46701, 43705, 27785, 1920,  28639,
    22522, 52934, 11906, 15861, 25354, 53239, 54373, 37039, 46885, 26329, 5070,
    22824, 49872, 10998, 22287, 16495, 6259,  12943, 42301, 23630, 32768, 1017,
    7843,  35162, 29087, 38962, 44497, 3777,  25503, 37919, 21350, 28855, 7876,
    48162, 962,   55374, 44437, 14375, 20298, 61420, 6544,  53268, 33633, 26563,
    19924, 8681,  47977, 44165, 58644, 58121, 54445, 40417, 12401, 61389, 30833,
    59039, 22920, 54072, 20078, 30618, 43644, 59623, 31109, 10547, 54574, 5601,
    45188, 10596, 59785, 24294, 21879, 58794, 58306, 61122, 43817, 53795, 50807,
    17539, 58352, 13797, 1462,  35015, 13454, 27047, 21240, 49035, 18569, 36622,
    18839, 30805, 49738, 49984, 24196, 34164, 18249, 42089, 56046, 13488, 27534,
    32263, 43039, 22863, 11387, 37592, 17922, 36748, 41016, 19663, 37215, 7682,
    8193,  382,   59433, 59409, 42206, 24293, 54374, 43347, 35601, 57454, 39937,
    28209, 48265, 57677, 43590, 24352, 41840, 37842, 4384,  42462, 39288, 32,
    4657,  20948, 61020, 36569, 20726, 33584, 2962,  5845,  42297, 9261,  1823,
    18968, 10952, 3005,  43715, 18289, 17738, 14482, 45470, 54547, 6644,  55434,
    60849, 13186, 10464, 14785, 30045, 42549, 38509, 51114, 46564, 54673, 28821,
    54691, 58321, 37943, 40203, 24140, 49388, 23323, 55291, 38131, 13802, 43374,
    18410, 9573,  1148,  33380, 57755, 9107,  29332, 44938, 7937,  10940, 2326,
    37447, 60181, 37184, 4626,  1993,  57720, 48347, 10605, 52104, 10157, 8826,
    5718,  53226, 46721, 658,   61199, 39847, 40810, 10818, 34492, 41264, 14704,
    23692, 45631, 26260, 35349, 17693, 30843, 49268, 4477,  34302, 19132, 57916,
    18851, 34885, 59816, 21042, 17099, 4536,  61080, 39384, 32950, 37972, 19463,
    47845, 41230, 45156, 51183, 20497, 31866, 46751, 16421, 58727, 23595, 27304,
    26001, 37141, 50209, 36552, 20172, 24788, 5450,  56606, 8688,  38966, 37399,
    25463, 5762,  34810, 39301, 27399, 11026, 15535, 50872, 8794,  1061,  13938,
    27742, 52838, 59376, 20879, 29858, 4973,  53636, 38302, 48288, 9210,  161,
    33154, 28705, 60845, 13105, 5553,  7482,  19517, 50528, 15367, 41783, 21699,
    49352, 21634, 11092, 11286, 2759,  1441,  54188, 44740, 52083, 1281,  30903,
    7025,  37381, 38564, 13456, 23428, 22571, 9339,  47735, 18197, 58110, 53644,
    42272, 3172,  23858, 23640, 15023, 19422, 4062,  36973, 41120, 49457, 7022,
    32484, 50241, 26985, 8377,  29495, 39575, 54091, 17083, 38585, 6912,  19459,
    30567, 36319, 34264, 36059, 4106,  18557, 33700, 14520, 39480, 9040,  56062,
    19474, 34670, 39375, 18200, 25566, 38032, 23026, 60069, 4990,  54190, 13093,
    21890, 37406, 40774, 59510, 16584, 18500, 42685, 41646, 12696, 31689, 17105,
    29377, 3202,  22926, 53196, 38139, 61047, 1070,  5956,  54152, 1000,  59237,
    40215, 58884, 21483, 61040, 5003,  45281, 44414, 50553, 28282, 26396, 39781,
    51781, 61072, 59489, 23128, 12433, 25681, 42608, 25975, 40370, 3641,  12101,
    405,   49489, 11679, 10331, 7779,  1018,  36789, 51750, 23920, 38213, 52616,
    51888, 24803, 59222, 36112, 55828, 37547, 19730, 10485, 46474, 47150, 15537,
    47323, 44202, 23708, 43104, 5997,  20235, 5257,  2044,  59382, 51881, 6504,
    8767,  18252, 57590, 44369, 30457, 52854, 52814, 40523, 58883, 53978, 23627,
    7371,  8511,  42437, 50491, 15419, 5093,  25019, 1309,  42658, 16591, 20230,
    17269, 45939, 53336, 35849, 48609, 37214, 29441, 12516, 34240, 6269,  49836,
    41058, 52354, 58060, 22281, 61090, 29613, 14507, 23815, 42411, 39031, 14218,
    20418, 18449, 30992, 55832, 12608, 53069, 57781, 43365, 23861, 22225, 3346,
    22300, 24580, 5900,  10564, 55128, 9490,  56270, 8278,  56529, 27538, 40855,
    47950, 8510,  49246, 43516, 34553, 34540, 32010, 31180, 8758,  3502,  43904,
    60981, 19379, 49645, 36812, 50330, 36798, 13732, 59566, 40094, 48087, 41888,
    59561, 18246, 26588, 6282,  54966, 31141, 53009, 32421, 9892,  18772, 41026,
    6948,  40077, 1321,  5656,  39752, 16099, 33110, 27626, 7581,  37636, 1285,
    3967,  56994, 54776, 61091, 34780, 31095, 58637, 60418, 59526, 49633, 28974,
    11754, 29210, 23059, 48481, 18586, 1579,  55071, 58277, 23387, 47623, 5082,
    33293, 58534, 32576, 9869,  5037,  1509,  55437, 24805, 27316, 4707,  51874,
    49646, 27225, 12584, 16950, 28315, 21060, 46599, 51195, 56432, 35862, 15757,
    7094,  7102,  60439, 57701, 29335, 16290, 10792, 19188, 40063, 26164, 47773,
    46112, 53947, 26847, 55601, 40992, 18537, 7749,  60936, 5228,  40477, 28813,
    8505,  53084, 12404, 46421, 31003, 5592,  16594, 45627, 33871, 15929, 35644,
    33952, 27600, 53718, 31909, 56802, 52250, 58285, 36254, 57445, 3055,  16431,
    48956, 5152,  6340,  54814, 42369, 50714, 14646, 216,   10134, 19430, 13702,
    16437, 18517, 43239, 43622, 8421,  11079, 32155, 40953, 44325, 36668, 60094,
    45782, 46284, 21056, 53697, 21000, 30187, 38971, 59247, 36211, 41587, 20852,
    47049, 41059, 40551, 13207, 3920,  11178, 10082, 53167, 59255, 5801,  58934,
    10382, 9441,  51538, 31468, 22270, 49889, 32342, 56456, 47725, 8406,  24785,
    41494, 31849, 40390, 43693, 36034, 21448, 33944, 52219, 21133, 13554, 33299,
    9923,  55924, 2285,  31094, 32052, 18092, 29603, 32252, 32629, 7982,  16083,
    61,
};

/// convert a polynomial into its NTT form
void hvc_ntt(uint16_t *p) {
  unsigned int t, ht, i, j, j1, j2, l, m;
  uint32_t u, v, s;

  t = N;
  for (l = 0; l < 9; l++) {
    m = 1 << l;
    ht = t >> 1;
    i = 0;
    j1 = 0;
    while (i < m) {
      s = NTT_TABLE[m + i];
      j2 = j1 + ht;
      j = j1;
      while (j < j2) {
        u = p[j];
        v = ((uint32_t)p[j + ht]) * s % 61441;
        p[j] = ((u + v) % 61441);
        p[j + ht] = (u + 61441 - v) % 61441;
        j++;
      }
      i++;
      j1 += t;
    }
    t = ht;
  }
}

/// convert an NTT form polynomial into its integer form
void hvc_inv_ntt(uint16_t *p) {
  unsigned int t, m, hm, dt, i, j, j1, j2;
  uint32_t s, u, v;

  t = 1;
  m = N;

  while (m > 1) {
    hm = m >> 1;
    dt = t << 1;
    i = 0;
    j1 = 0;
    while (i < hm) {
      j2 = j1 + t;
      s = INV_NTT_TABLE[hm + i];
      j = j1;
      while (j < j2) {
        u = p[j];
        v = p[j + t];
        p[j] = (u + v) % 61441;
        p[j + t] = (uint16_t)(((u + 61441 - v) % 61441) * s % 61441);
        j++;
      }
      i++;
      j1 += dt;
    }
    t = dt;
    m = hm;
  }

  for (i = 0; i < N; i++) {
    p[i] = (uint16_t)(((uint32_t)p[i]) * 61321 % 61441);
  }
}
