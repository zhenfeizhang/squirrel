// NTT functions for small ring with q = 61441 and n = 512
#include "params.h"
#include <stdint.h>

/// NTT forward table where the i-th element is g^rev(i) where
/// - g = 61 is a primitive root
/// - rev(i) is the reverse bit decomposition of i, i.e.,
///   0   ->  0
///   1   ->  100 0000
///   2   ->  010 0000
///   3   ->  110 0000   ...
static const uint16_t NTT_TABLE[] = {
    1,     61440, 28946, 32495, 44853, 16588, 5167,  56274, 41593, 19848, 14583,
    46858, 37746, 23695, 51854, 9587,  29671, 31770, 34468, 26973, 21303, 40138,
    14762, 46679, 1977,  59464, 24671, 36770, 15018, 46423, 15953, 45488, 5261,
    56180, 34108, 27333, 38193, 23248, 26665, 34776, 29372, 32069, 42795, 18646,
    4394,  57047, 5854,  55587, 38991, 22450, 23757, 37684, 6699,  54742, 1458,
    59983, 17468, 43973, 30739, 30702, 58013, 3428,  327,   61114, 25525, 35916,
    18625, 42816, 42672, 18769, 35289, 26152, 22286, 39155, 21497, 39944, 10329,
    51112, 11328, 50113, 30509, 30932, 22021, 39420, 6225,  55216, 43838, 17603,
    19864, 41577, 18466, 42975, 4051,  57390, 30818, 30623, 38440, 23001, 49171,
    12270, 53419, 8022,  42168, 19273, 17218, 44223, 44277, 17164, 27025, 34416,
    60279, 1162,  23957, 37484, 36196, 25245, 1672,  59769, 43645, 17796, 54804,
    6637,  11405, 50036, 53725, 7716,  52140, 9301,  10158, 51283, 38283, 23158,
    31759, 29682, 15772, 45669, 33378, 28063, 61304, 137,   32028, 29413, 60680,
    761,   29913, 31528, 35126, 26315, 672,   60769, 36356, 25085, 52600, 8841,
    51620, 9821,  56282, 5159,  30657, 30784, 49009, 12432, 3265,  58176, 26020,
    35421, 31142, 30299, 3280,  58161, 16535, 44906, 28086, 33355, 51485, 9956,
    21892, 39549, 44799, 16642, 33255, 28186, 3083,  58358, 59777, 1664,  3600,
    57841, 15423, 46018, 3852,  57589, 1930,  59511, 15911, 45530, 57362, 4079,
    18868, 42573, 32544, 28897, 5212,  56229, 42195, 19246, 52272, 9169,  2018,
    59423, 44078, 17363, 10761, 50680, 43477, 17964, 6268,  55173, 59696, 1745,
    46029, 15412, 7349,  54092, 15965, 45476, 25129, 36312, 44731, 16710, 37333,
    24108, 39358, 22083, 17646, 43795, 1562,  59879, 54517, 6924,  48846, 12595,
    16024, 45417, 26460, 34981, 49095, 12346, 43572, 17869, 35705, 25736, 19588,
    41853, 16700, 44741, 441,   61000, 46899, 14542, 57612, 3829,  5330,  56111,
    33095, 28346, 41239, 20202, 56916, 4525,  11562, 49879, 59419, 2022,  24461,
    36980, 55591, 5850,  58737, 2704,  11683, 49758, 4854,  56587, 48751, 12690,
    30999, 30442, 46784, 14657, 50024, 11417, 8279,  53162, 24034, 37407, 50442,
    10999, 10208, 51233, 33083, 28358, 1092,  60349, 52992, 8449,  31867, 29574,
    5091,  56350, 28568, 32873, 23263, 38178, 38879, 22562, 24277, 37164, 21325,
    40116, 12822, 48619, 41972, 19469, 17406, 44035, 17876, 43565, 59007, 2434,
    18263, 43178, 8455,  52986, 18927, 42514, 60331, 1110,  3583,  57858, 41821,
    19620, 40084, 21357, 35402, 26039, 33294, 28147, 4702,  56739, 12277, 49164,
    55765, 5676,  57179, 4262,  25876, 35565, 40906, 20535, 35895, 25546, 49360,
    12081, 59912, 1529,  40527, 20914, 58626, 2815,  49217, 12224, 60,    61381,
    16412, 45029, 22251, 39190, 52884, 8557,  37940, 23501, 14806, 46635, 55926,
    5515,  47969, 13472, 58612, 2829,  12619, 48822, 35299, 26142, 1024,  60417,
    54359, 7082,  33045, 28396, 43259, 18182, 7434,  54007, 50588, 10853, 58336,
    3105,  33343, 28098, 31250, 30191, 59639, 1802,  2717,  58724, 47178, 14263,
    26722, 34719, 46794, 14647, 32279, 29162, 33337, 28104, 41897, 19544, 36285,
    25156, 33156, 28285, 8135,  53306, 33798, 27643, 42497, 18944, 7901,  53540,
    3468,  57973, 51575, 9866,  43033, 18408, 39825, 21616, 52397, 9044,  12477,
    48964, 44391, 17050, 26253, 35188, 36151, 25290, 25175, 36266, 52813, 8628,
    11577, 49864, 29764, 31677, 23042, 38399, 14644, 46797, 3765,  57676, 60784,
    657,   29188, 32253, 23259, 38182, 45977, 15464, 36291, 25150, 22509, 38932,
    3810,  57631, 59106, 2335,  30516, 30925, 40320, 21121, 12991, 48450, 18566,
    42875, 36736, 24705, 869,   60572, 56511, 4930,  23663, 37778, 45660, 15781,
    17009, 44432, 36568, 24873, 53221, 8220,  61420, 21,    6544,  54897, 41143,
    20298, 14375, 47066, 48162, 13279, 962,   60479, 6067,  55374, 17004, 44437,
    52760, 8681,  13464, 47977, 44165, 17276, 58644, 2797,  19924, 41517, 34878,
    26563, 53268, 8173,  33633, 27808, 12401, 49040, 21024, 40417, 58121, 3320,
    54445, 6996,  59039, 2402,  22920, 38521, 30608, 30833, 61389, 52,    41363,
    20078, 54072, 7369,  43644, 17797, 30823, 30618, 1818,  59623, 30332, 31109,
    10547, 50894, 54574, 6867,  16944, 44497, 38962, 22479, 25503, 35938, 57664,
    3777,  23522, 37919, 40091, 21350, 28855, 32586, 7876,  53565, 35162, 26279,
    29087, 32354, 53598, 7843,  1017,  60424, 12943, 48498, 42301, 19140, 37811,
    23630, 28673, 32768, 52934, 8507,  11906, 49535, 45580, 15861, 36087, 25354,
    7068,  54373, 53239, 8202,  46885, 14556, 24402, 37039, 49872, 11569, 38617,
    22824, 26329, 35112, 5070,  56371, 16495, 44946, 6259,  55182, 39154, 22287,
    10998, 50443, 32446, 28995, 56231, 5210,  8912,  52529, 37434, 24007, 36354,
    25087, 2877,  58564, 3263,  58178, 15981, 45460, 47678, 13763, 61087, 354,
    47329, 14112, 35257, 26184, 1338,  60103, 21918, 39523, 46898, 14543, 32054,
    29387, 15308, 46133, 54317, 7124,  6549,  54892, 21869, 39572, 54002, 7439,
    21411, 40030, 24604, 36837, 24753, 36688, 31796, 29645, 42277, 19164, 38937,
    22504, 58139, 3302,  34944, 26497, 47282, 14159, 44763, 16678, 41990, 19451,
    20911, 40530, 34515, 26926, 24218, 37223, 33859, 27582, 53868, 7573,  13430,
    48011, 35520, 25921, 8226,  53215, 19063, 42378, 57418, 4023,  19783, 41658,
    8598,  52843, 52695, 8746,  36645, 24796, 16447, 44994, 29994, 31447, 33381,
    28060, 25260, 36181, 43705, 17736, 14740, 46701, 33656, 27785, 59521, 1920,
    28639, 32802, 22522, 38919, 18731, 42710, 32142, 29299, 58750, 2691,  13502,
    47939, 6603,  54838, 48928, 12513, 18739, 42702, 17946, 43495, 52180, 9261,
    59618, 1823,  18968, 42473, 10952, 50489, 42297, 19144, 55596, 5845,  33584,
    27857, 2962,  58479, 42462, 18979, 39288, 22153, 61409, 32,    56784, 4657,
    421,   61020, 20948, 40493, 20726, 40715, 24872, 36569, 592,   60849, 55434,
    6007,  10464, 50977, 48255, 13186, 46656, 14785, 31396, 30045, 42549, 18892,
    38509, 22932, 54547, 6894,  6644,  54797, 15971, 45470, 14482, 46959, 3005,
    58436, 43715, 17726, 43152, 18289, 43703, 17738, 37943, 23498, 40203, 21238,
    3120,  58321, 54691, 6750,  51114, 10327, 46564, 14877, 6768,  54673, 32620,
    28821, 23310, 38131, 47639, 13802, 43374, 18067, 18410, 43031, 55291, 6150,
    38118, 23323, 24140, 37301, 49388, 12053, 57755, 3686,  28061, 33380, 9573,
    51868, 1148,  60293, 44938, 16503, 7937,  53504, 32109, 29332, 9107,  52334,
    59115, 2326,  10940, 50501, 60181, 1260,  23994, 37447, 24257, 37184, 56815,
    4626,  1993,  59448, 57720, 3721,  54374, 7067,  37148, 24293, 59409, 2032,
    42206, 19235, 57454, 3987,  39937, 21504, 25840, 35601, 43347, 18094, 13176,
    48265, 28209, 33232, 43590, 17851, 3764,  57677, 37089, 24352, 19601, 41840,
    37842, 23599, 4384,  57057, 53759, 7682,  53248, 8193,  382,   61059, 59433,
    2008,  37215, 24226, 41778, 19663, 36748, 24693, 41016, 20425, 13488, 47953,
    27534, 33907, 29178, 32263, 18402, 43039, 50054, 11387, 22863, 38578, 17922,
    43519, 23849, 37592, 5601,  55840, 45188, 16253, 50845, 10596, 1656,  59785,
    39562, 21879, 24294, 37147, 58306, 3135,  2647,  58794, 50807, 10634, 7646,
    53795, 61122, 319,   43817, 17624, 13797, 47644, 1462,  59979, 3089,  58352,
    17539, 43902, 36622, 24819, 18839, 42602, 42872, 18569, 49035, 12406, 35015,
    26426, 13454, 47987, 34394, 27047, 40201, 21240, 27277, 34164, 43192, 18249,
    42089, 19352, 56046, 5395,  24196, 37245, 11457, 49984, 30805, 30636, 49738,
    11703,
};

/// NTT reverse table where the i-th element is (1/g)^rev(i) where
/// - g = 61 is a primitive root
/// - 1/g = 49738
/// - rev(i) is the reverse bit decomposition of i, i.e.,
///   0   ->  0
///   1   ->  100 0000
///   2   ->  010 0000
///   3   ->  110 0000   ...
static const uint16_t INV_NTT_TABLE[] = {
    1,     61440, 32495, 28946, 56274, 5167,  16588, 44853, 9587,  51854, 23695,
    37746, 46858, 14583, 19848, 41593, 45488, 15953, 46423, 15018, 36770, 24671,
    59464, 1977,  46679, 14762, 40138, 21303, 26973, 34468, 31770, 29671, 61114,
    327,   3428,  58013, 30702, 30739, 43973, 17468, 59983, 1458,  54742, 6699,
    37684, 23757, 22450, 38991, 55587, 5854,  57047, 4394,  18646, 42795, 32069,
    29372, 34776, 26665, 23248, 38193, 27333, 34108, 56180, 5261,  9301,  52140,
    7716,  53725, 50036, 11405, 6637,  54804, 17796, 43645, 59769, 1672,  25245,
    36196, 37484, 23957, 1162,  60279, 34416, 27025, 17164, 44277, 44223, 17218,
    19273, 42168, 8022,  53419, 12270, 49171, 23001, 38440, 30623, 30818, 57390,
    4051,  42975, 18466, 41577, 19864, 17603, 43838, 55216, 6225,  39420, 22021,
    30932, 30509, 50113, 11328, 51112, 10329, 39944, 21497, 39155, 22286, 26152,
    35289, 18769, 42672, 42816, 18625, 35916, 25525, 44741, 16700, 41853, 19588,
    25736, 35705, 17869, 43572, 12346, 49095, 34981, 26460, 45417, 16024, 12595,
    48846, 6924,  54517, 59879, 1562,  43795, 17646, 22083, 39358, 24108, 37333,
    16710, 44731, 36312, 25129, 45476, 15965, 54092, 7349,  15412, 46029, 1745,
    59696, 55173, 6268,  17964, 43477, 50680, 10761, 17363, 44078, 59423, 2018,
    9169,  52272, 19246, 42195, 56229, 5212,  28897, 32544, 42573, 18868, 4079,
    57362, 45530, 15911, 59511, 1930,  57589, 3852,  46018, 15423, 57841, 3600,
    1664,  59777, 58358, 3083,  28186, 33255, 16642, 44799, 39549, 21892, 9956,
    51485, 33355, 28086, 44906, 16535, 58161, 3280,  30299, 31142, 35421, 26020,
    58176, 3265,  12432, 49009, 30784, 30657, 5159,  56282, 9821,  51620, 8841,
    52600, 25085, 36356, 60769, 672,   26315, 35126, 31528, 29913, 761,   60680,
    29413, 32028, 137,   61304, 28063, 33378, 45669, 15772, 29682, 31759, 23158,
    38283, 51283, 10158, 8220,  53221, 24873, 36568, 44432, 17009, 15781, 45660,
    37778, 23663, 4930,  56511, 60572, 869,   24705, 36736, 42875, 18566, 48450,
    12991, 21121, 40320, 30925, 30516, 2335,  59106, 57631, 3810,  38932, 22509,
    25150, 36291, 15464, 45977, 38182, 23259, 32253, 29188, 657,   60784, 57676,
    3765,  46797, 14644, 38399, 23042, 31677, 29764, 49864, 11577, 8628,  52813,
    36266, 25175, 25290, 36151, 35188, 26253, 17050, 44391, 48964, 12477, 9044,
    52397, 21616, 39825, 18408, 43033, 9866,  51575, 57973, 3468,  53540, 7901,
    18944, 42497, 27643, 33798, 53306, 8135,  28285, 33156, 25156, 36285, 19544,
    41897, 28104, 33337, 29162, 32279, 14647, 46794, 34719, 26722, 14263, 47178,
    58724, 2717,  1802,  59639, 30191, 31250, 28098, 33343, 3105,  58336, 10853,
    50588, 54007, 7434,  18182, 43259, 28396, 33045, 7082,  54359, 60417, 1024,
    26142, 35299, 48822, 12619, 2829,  58612, 13472, 47969, 5515,  55926, 46635,
    14806, 23501, 37940, 8557,  52884, 39190, 22251, 45029, 16412, 61381, 60,
    12224, 49217, 2815,  58626, 20914, 40527, 1529,  59912, 12081, 49360, 25546,
    35895, 20535, 40906, 35565, 25876, 4262,  57179, 5676,  55765, 49164, 12277,
    56739, 4702,  28147, 33294, 26039, 35402, 21357, 40084, 19620, 41821, 57858,
    3583,  1110,  60331, 42514, 18927, 52986, 8455,  43178, 18263, 2434,  59007,
    43565, 17876, 44035, 17406, 19469, 41972, 48619, 12822, 40116, 21325, 37164,
    24277, 22562, 38879, 38178, 23263, 32873, 28568, 56350, 5091,  29574, 31867,
    8449,  52992, 60349, 1092,  28358, 33083, 51233, 10208, 10999, 50442, 37407,
    24034, 53162, 8279,  11417, 50024, 14657, 46784, 30442, 30999, 12690, 48751,
    56587, 4854,  49758, 11683, 2704,  58737, 5850,  55591, 36980, 24461, 2022,
    59419, 49879, 11562, 4525,  56916, 20202, 41239, 28346, 33095, 56111, 5330,
    3829,  57612, 14542, 46899, 61000, 441,   11703, 49738, 30636, 30805, 49984,
    11457, 37245, 24196, 5395,  56046, 19352, 42089, 18249, 43192, 34164, 27277,
    21240, 40201, 27047, 34394, 47987, 13454, 26426, 35015, 12406, 49035, 18569,
    42872, 42602, 18839, 24819, 36622, 43902, 17539, 58352, 3089,  59979, 1462,
    47644, 13797, 17624, 43817, 319,   61122, 53795, 7646,  10634, 50807, 58794,
    2647,  3135,  58306, 37147, 24294, 21879, 39562, 59785, 1656,  10596, 50845,
    16253, 45188, 55840, 5601,  37592, 23849, 43519, 17922, 38578, 22863, 11387,
    50054, 43039, 18402, 32263, 29178, 33907, 27534, 47953, 13488, 20425, 41016,
    24693, 36748, 19663, 41778, 24226, 37215, 2008,  59433, 61059, 382,   8193,
    53248, 7682,  53759, 57057, 4384,  23599, 37842, 41840, 19601, 24352, 37089,
    57677, 3764,  17851, 43590, 33232, 28209, 48265, 13176, 18094, 43347, 35601,
    25840, 21504, 39937, 3987,  57454, 19235, 42206, 2032,  59409, 24293, 37148,
    7067,  54374, 3721,  57720, 59448, 1993,  4626,  56815, 37184, 24257, 37447,
    23994, 1260,  60181, 50501, 10940, 2326,  59115, 52334, 9107,  29332, 32109,
    53504, 7937,  16503, 44938, 60293, 1148,  51868, 9573,  33380, 28061, 3686,
    57755, 12053, 49388, 37301, 24140, 23323, 38118, 6150,  55291, 43031, 18410,
    18067, 43374, 13802, 47639, 38131, 23310, 28821, 32620, 54673, 6768,  14877,
    46564, 10327, 51114, 6750,  54691, 58321, 3120,  21238, 40203, 23498, 37943,
    17738, 43703, 18289, 43152, 17726, 43715, 58436, 3005,  46959, 14482, 45470,
    15971, 54797, 6644,  6894,  54547, 22932, 38509, 18892, 42549, 30045, 31396,
    14785, 46656, 13186, 48255, 50977, 10464, 6007,  55434, 60849, 592,   36569,
    24872, 40715, 20726, 40493, 20948, 61020, 421,   4657,  56784, 32,    61409,
    22153, 39288, 18979, 42462, 58479, 2962,  27857, 33584, 5845,  55596, 19144,
    42297, 50489, 10952, 42473, 18968, 1823,  59618, 9261,  52180, 43495, 17946,
    42702, 18739, 12513, 48928, 54838, 6603,  47939, 13502, 2691,  58750, 29299,
    32142, 42710, 18731, 38919, 22522, 32802, 28639, 1920,  59521, 27785, 33656,
    46701, 14740, 17736, 43705, 36181, 25260, 28060, 33381, 31447, 29994, 44994,
    16447, 24796, 36645, 8746,  52695, 52843, 8598,  41658, 19783, 4023,  57418,
    42378, 19063, 53215, 8226,  25921, 35520, 48011, 13430, 7573,  53868, 27582,
    33859, 37223, 24218, 26926, 34515, 40530, 20911, 19451, 41990, 16678, 44763,
    14159, 47282, 26497, 34944, 3302,  58139, 22504, 38937, 19164, 42277, 29645,
    31796, 36688, 24753, 36837, 24604, 40030, 21411, 7439,  54002, 39572, 21869,
    54892, 6549,  7124,  54317, 46133, 15308, 29387, 32054, 14543, 46898, 39523,
    21918, 60103, 1338,  26184, 35257, 14112, 47329, 354,   61087, 13763, 47678,
    45460, 15981, 58178, 3263,  58564, 2877,  25087, 36354, 24007, 37434, 52529,
    8912,  5210,  56231, 28995, 32446, 50443, 10998, 22287, 39154, 55182, 6259,
    44946, 16495, 56371, 5070,  35112, 26329, 22824, 38617, 11569, 49872, 37039,
    24402, 14556, 46885, 8202,  53239, 54373, 7068,  25354, 36087, 15861, 45580,
    49535, 11906, 8507,  52934, 32768, 28673, 23630, 37811, 19140, 42301, 48498,
    12943, 60424, 1017,  7843,  53598, 32354, 29087, 26279, 35162, 53565, 7876,
    32586, 28855, 21350, 40091, 37919, 23522, 3777,  57664, 35938, 25503, 22479,
    38962, 44497, 16944, 6867,  54574, 50894, 10547, 31109, 30332, 59623, 1818,
    30618, 30823, 17797, 43644, 7369,  54072, 20078, 41363, 52,    61389, 30833,
    30608, 38521, 22920, 2402,  59039, 6996,  54445, 3320,  58121, 40417, 21024,
    49040, 12401, 27808, 33633, 8173,  53268, 26563, 34878, 41517, 19924, 2797,
    58644, 17276, 44165, 47977, 13464, 8681,  52760, 44437, 17004, 55374, 6067,
    60479, 962,   13279, 48162, 47066, 14375, 20298, 41143, 54897, 6544,  21,
    61420,
};

/// convert a polynomial into its NTT form
void hvc_ntt(uint16_t *p) {
  unsigned int t, ht, i, j, j1, j2, l, m;
  uint32_t u, v, s;

  t = N;
  for (l = 0; l < 9; l++) {
    m = 1 << l;
    ht = t >> 1;
    i = 0;
    j1 = 0;
    while (i < m) {
      s = NTT_TABLE[m + i];
      j2 = j1 + ht;
      j = j1;
      while (j < j2) {
        u = p[j];
        v = ((uint32_t)p[j + ht]) * s % 61441;
        p[j] = ((u + v) % 61441);
        p[j + ht] = (u + 61441 - v) % 61441;
        j++;
      }
      i++;
      j1 += t;
    }
    t = ht;
  }
}

/// convert an NTT form polynomial into its integer form
void hvc_inv_ntt(uint16_t *p) {
  unsigned int t, m, hm, dt, i, j, j1, j2;
  uint32_t s, u, v;

  t = 1;
  m = N;

  while (m > 1) {
    hm = m >> 1;
    dt = t << 1;
    i = 0;
    j1 = 0;
    while (i < hm) {
      j2 = j1 + t;
      s = INV_NTT_TABLE[hm + i];
      j = j1;
      while (j < j2) {
        u = p[j];
        v = p[j + t];
        p[j] = (u + v) % 61441;
        p[j + t] = (uint16_t)(((u + 61441 - v)%61441) * s % 61441);
        j++;
      }
      i++;
      j1 += dt;
    }
    t = dt;
    m = hm;
  }

  for (i = 0; i < N; i++) {
    p[i] = (uint16_t)(((uint32_t)p[i]) * 61321 % 61441);
  }
}
